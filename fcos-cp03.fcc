variant: fcos
version: 1.2.0
systemd:
  units:
  - name: getty@tty1.service
    dropins:
    - name: autologin-core.conf
      contents: |
        [Service]
        ExecStart=
        ExecStart=-/usr/sbin/agetty --autologin core --noclear %I $TERM
  - name: run-k3s-prereq-installer.service
    enabled: true
    contents: |
      [Unit]
      After=network-online.target
      Wants=network-online.target
      Before=systemd-user-sessions.service
      OnFailure=emergency.target
      OnFailureJobMode=replace-irreversibly
      ConditionPathExists=!/var/lib/k3s-prereq-installed
      [Service]
      RemainAfterExit=yes
      Type=oneshot
      ExecStart=/usr/local/bin/run-k3s-prereq-installer
      ExecStartPost=/usr/bin/touch /var/lib/k3s-prereq-installed
      ExecStartPost=/usr/bin/systemctl --no-block reboot
      StandardOutput=kmsg+console
      StandardError=kmsg+console
      [Install]
      WantedBy=multi-user.target
  - name: run-k3s-installer.service
    enabled: true
    contents: |
      [Unit]
      After=network-online.target
      Wants=network-online.target
      Before=systemd-user-sessions.service
      OnFailure=emergency.target
      OnFailureJobMode=replace-irreversibly
      ConditionPathExists=/var/lib/k3s-prereq-installed
      ConditionPathExists=!/var/lib/k3s-installed
      [Service]
      RemainAfterExit=yes
      Type=oneshot
      ExecStart=/usr/local/bin/run-k3s-installer
      ExecStartPost=/usr/bin/touch /var/lib/k3s-installed
      StandardOutput=kmsg+console
      StandardError=kmsg+console
      [Install]
      WantedBy=multi-user.target
storage:
  files:
    - path: /etc/hostname
      mode: 0644
      contents:
        inline: |
          cp03.local
    - path: /etc/sysctl.d/20-silence-audit.conf
      mode: 0644
      contents:
        inline: |
          # Raise console message logging level from DEBUG (7) to WARNING (4)
          # to hide audit messages from the interactive console
          kernel.printk=4
    - path: /usr/local/bin/run-k3s-prereq-installer
      mode: 0755
      contents:
        inline: |
          #!/usr/bin/env sh
          main() {
            rpm-ostree install https://github.com/k3s-io/k3s-selinux/releases/download/v0.2.stable.1/k3s-selinux-0.2-1.el7_8.noarch.rpm
            return 0
          }
          main
    - path: /usr/local/bin/run-k3s-installer
      mode: 0755
      contents:
        inline: |
          #!/usr/bin/env sh
          main() {
            export K3S_KUBECONFIG_MODE="644"
            export K3S_TOKEN="very_secret"
            export INSTALL_K3S_EXEC="server --server https://192.168.178.94:6443"

            curl -sfL https://get.k3s.io | sh -
            return 0
          }
          main
passwd:
  users:
    - name: core
      ssh_authorized_keys:
      - ssh-rsa AAAAB3NzaC1yc2EAAAABJQAAAQEAnwm807zV8im1zCfY8XJQN/SzldUKCRvIQaR7Lm5WKPvs6wYRgR6l29hcx5U1JGmjQ1hBvfJ9+XPNWAAMrIdWLfAoel1SrlYK91Uc9uylMly7GWhw5BCI5cYqGXzr3GOYVx1mQ9PVH4GQM3USVWpCF9hXBGV4f3q6ezmwBkQeW9zwGmaMpbIQDd7deEGiQ3HhnM4ccCMbzz8NG1Ca9HFANyWVqUL37GCEoQDDQm80uoGxMbWT6UyWFPuXkqrtc5q05XvLhPbCMq4kN846I+ZfKPv8K6SchuVo8xcUOGQkZb1WAvPiRJzTBNknX3gnfH/28GVqWbfXXfCdneuUeJ6u5Q== stijn@kzp.sandcat.nl
